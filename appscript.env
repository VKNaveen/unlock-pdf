function saveClientPDFAttachments() {
  const SUBJECT_KEYWORD = "XYZ";

  // Client configuration
  const CLIENTS = [
    {
      email: "vknaveen2002@gmail.com",
      passwords: ["naveen2002", "naveen"],
    }
  ];

  // Drive folders
  const FOLDER_UNLOCKED_ID = "1guI56_J9-YLjXHTLIk4XYNhR_Fzt5h38"; // unlocked
  const FOLDER_NORMAL_ID   = "1CiJhvcxzvyqwnAb7L5KKo9g0vfeQySC0"; // normal
  const FOLDER_LOCKED_ID   = "1bReAg4AW94Z2lvkuMkN9CEGaEpp7fuxC"; // locked

  const folderUnlocked = DriveApp.getFolderById(FOLDER_UNLOCKED_ID);
  const folderNormal   = DriveApp.getFolderById(FOLDER_NORMAL_ID);
  const folderLocked   = DriveApp.getFolderById(FOLDER_LOCKED_ID);

  const fromQuery = CLIENTS.map(c => `from:${c.email}`).join(" OR ");
  const searchQuery = `(${fromQuery}) subject:${SUBJECT_KEYWORD}`;
  const threads = GmailApp.search(searchQuery);
  Logger.log(`Found ${threads.length} threads`);

  let unlocked = 0, normal = 0, locked = 0;

  threads.forEach(thread => {
    thread.getMessages().forEach(msg => {
      const sender = msg.getFrom();
      const client = CLIENTS.find(c => sender.includes(c.email));
      const passwords = client ? client.passwords : [];

      msg.getAttachments().forEach(att => {
        const name = att.getName();
        if (!name.toLowerCase().endsWith(".pdf")) return;

        Logger.log(`Processing: ${name} from ${client?.email || "unknown"}`);

        const blob = att.copyBlob();
        const result = tryUnlockWithNodeServer(blob, passwords);


        if (result.status === "unlocked") {
          const newName = name.replace(".pdf", "_unlocked.pdf");
          if (!fileExists(folderUnlocked, newName)) {
            folderUnlocked.createFile(result.blob).setName(newName);
            unlocked++;
            Logger.log(`Unlocked and saved: ${newName}`);
          } else {
            Logger.log(`Skipped (already exists in Unlocked): ${newName}`);
          }

        } else if (result.status === "already_unlocked") {
          if (!fileExists(folderNormal, name)) {
            folderNormal.createFile(blob).setName(name);
            normal++;
            Logger.log(`Already unprotected — saved: ${name}`);
          } else {
            Logger.log(`Skipped (already exists in Normal): ${name}`);
          }

        } else {
          if (!fileExists(folderLocked, name)) {
            folderLocked.createFile(blob).setName(name);
            locked++;
            Logger.log(`Could not unlock — saved to Locked: ${name}`);
          } else {
            Logger.log(`Skipped (already exists in Locked): ${name}`);
          }
        }
      });
    });
  });

  Logger.log(`Summary — Unlocked: ${unlocked}, Normal: ${normal}, Locked: ${locked}`);
}


function fileExists(folder, fileName) {
  return folder.getFilesByName(fileName).hasNext();
}

function tryUnlockWithNodeServer(blob, passwords) {
  const apiUrl = "https://hemimetabolous-venice-uniocular.ngrok-free.dev/unlock-pdf";
  
  const formData = {
    method: "post",
    muteHttpExceptions: true,
    payload: {
      file: blob,
      passwords: JSON.stringify(passwords),
    },
  };

  try {
    const response = UrlFetchApp.fetch(apiUrl, formData);
    const result = JSON.parse(response.getContentText());
    Logger.log(`Node server response: ${response.getContentText().substring(0, 200)}`);

    if (result.status === "unlocked") {
      const unlockedBytes = Utilities.base64Decode(result.data);
      const unlockedBlob = Utilities.newBlob(unlockedBytes, "application/pdf", blob.getName());
      return { status: "unlocked", blob: unlockedBlob };
    }

    return { status: result.status || "locked" };
  } catch (error) {
    Logger.log(`Error calling Node server: ${error.message}`);
    return { status: "error" };
  }
}
